<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rotterdam - Itinerario con Audio</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{ --sidebar-width:380px; }
    body,html{ height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; color:#222; background:#f4f6f8; }
    #app { display:flex; height:100vh; }
    #sidebar {
      width:var(--sidebar-width);
      min-width:280px;
      max-width:46%;
      box-sizing:border-box;
      padding:14px;
      overflow:auto;
      background:#fff;
      border-right:1px solid #e3e6e9;
    }
    #map { flex:1; }
    h1{ font-size:18px; margin:0 0 8px 0; }
    .note{ font-size:13px; color:#666; margin-bottom:10px; }
    .stop{ background:#fbfbfd; border-radius:8px; padding:10px; margin-bottom:12px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .stop h3{ margin:0 0 6px 0; font-size:15px; }
    .meta{ font-size:13px; color:#555; margin-bottom:8px; }
    .desc{ font-size:14px; line-height:1.45; color:#333; }
    .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:8px 10px; border-radius:6px; text-decoration:none; display:inline-block; background:#007bff; color:white; font-size:14px; border:0; cursor:pointer; }
    .btn.alt{ background:#6c757d; }
    .btn.green{ background:#28a745; }
    .btn.small{ padding:6px 8px; font-size:13px; }
    footer{ font-size:12px; color:#666; margin-top:10px; }
    .top-actions{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .voices{ margin-top:6px; font-size:13px; }
    .search { margin-bottom:10px; }
    @media (max-width:820px){
      #sidebar{ position:fixed; z-index:1000; top:0; left:0; right:0; height:40vh; max-height:40vh; overflow:auto; }
      #map{ height:60vh; }
      #app{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <h1>Rotterdam ‚Äî Itinerario intensivo (1 Dicembre)</h1>
      <div class="note">Include descrizioni estese per ogni tappa e una guida vocale in italiano. Usa i bottoni "GUIDAMI" per aprire Google Maps. Consiglio: su mobile aggiungi la pagina alla Home per accesso rapido.</div>

      <div class="top-actions">
        <button id="playAll" class="btn small">‚ñ∂Ô∏è Play All</button>
        <button id="pauseAll" class="btn alt small">‚è∏Ô∏è Pausa/Resume</button>
        <button id="stopAll" class="btn green small">‚èπÔ∏è Stop</button>
        <button id="locateMobile" class="btn small">üìç Mostrami (posizione)</button>
      </div>

      <div class="voices">
        <label for="voiceSelect">Voce:</label>
        <select id="voiceSelect" class="voice-select"></select>
        <label style="margin-left:10px;font-size:13px;">Velocit√†:
          <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1" style="vertical-align:middle"/>
        </label>
      </div>

      <div id="stops"></div>

      <hr/>
      <div class="note"><strong>Note tecniche:</strong> la lettura vocale utilizza la Web Speech API del browser. Alcuni browser/sistemi potrebbero non avere voci italiane preinstallate: se la voce predefinita non √® italiana cambia la selezione "Voce". Per registrare MP3 vedi istruzioni nel footer.</div>
      <footer>File generato localmente ‚Äî salva come <em>rotterdam_itinerario_audio.html</em>. Buona visita!</footer>
    </div>

    <div id="map"></div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ======= DATI TAPPE (coordinate approssimative) e testi estesi =======
  const stops = [
    {
      id: 'centraal',
      name: 'Rotterdam Centraal (stazione)',
      coord: [51.9244,4.4680],
      time: '11:00',
      text: `Rotterdam Centraal √® la stazione principale, completamente rinnovata e inaugurata nel 2014. La grande copertura metallica e il volume interno la rendono subito riconoscibile: √® un esempio di architettura pubblica moderna che vuole dare immagine di efficienza e apertura. Quando esci dalla stazione, osserva le linee nette e l'uso di acciaio e vetro, temi ricorrenti nell'architettura contemporanea di Rotterdam.`
    },
    {
      id: 'lijnbaan',
      name: 'Lijnbaan (area commerciale)',
      coord: [51.9225,4.4780],
      time: '11:15',
      text: `La Lijnbaan fu progettata subito dopo la Seconda Guerra mondiale come prima area pedonale europea di una certa scala. Rappresenta la filosofia ricostruttiva della citt√†: ampi spazi, connessioni dirette e un orientamento verso il commercio moderno. Noterai facciate di negozi e spazi pubblici pensati per il passeggio.`
    },
    {
      id: 'stadhuis',
      name: 'Stadhuis (Municipio)',
      coord: [51.9222,4.4799],
      time: '11:25',
      text: `Il Municipio √® un edificio storico in stile neorinascimentale costruito tra il 1914 e il 1920: √® uno dei pochi sopravvissuti al bombardamento del 1940, per questo ha un valore simbolico molto forte. Osserva la torre con l'orologio e le sculture allegoriche: testimoniano l'importanza civica dell'edificio nella Rotterdam dell'inizio '900.`
    },
    {
      id: 'laurens',
      name: 'Sint-Laurenskerk (Laurenskerk)',
      coord: [51.9220,4.4845],
      time: '11:35',
      text: `La Laurenskerk √® l'unica chiesa medievale sopravvissuta in citt√†: costruita tra il XV e il XVI secolo, fu gravemente danneggiata nel 1940 e in seguito restaurata. √à il simbolo della memoria storica di Rotterdam: la sua torre in mattoni e il linguaggio gotico emergono in netto contrasto con gli edifici moderni attorno.`
    },
    {
      id: 'markthal',
      name: 'Markthal (mercato coperto)',
      coord: [51.9202,4.4819],
      time: '12:00',
      text: `Il Markthal √® un grande arco abitato che ospita bancarelle alimentari, negozi e residenze attorno all'arco. All'interno si trova 'Horn of Plenty', un gigantesco murale che raffigura frutta e prodotti: √® considerata la pi√π ampia opera d'arte interna dei Paesi Bassi. Perfetto per un pranzo veloce: troverai opzioni internazionali e soluzioni senza glutine.`
    },
    {
      id: 'cubus',
      name: 'Case Cubiche (Kubuswoningen)',
      coord: [51.9206,4.4883],
      time: '13:15',
      text: `Le Case Cubiche di Piet Blom, create negli anni '70-'80, sono cubi inclinati di 45 gradi poggiati su pilastri: l'idea era creare una "foresta" abitata, dove ogni cubo √® un albero. Osserva come l'orientamento della casa giochi con luce e spazi interni: √® una delle icone dell'architettura sperimentale di Rotterdam.`
    },
    {
      id: 'oude',
      name: 'Oude Haven (Vecchio Porto) & Witte Huis',
      coord: [51.9188,4.4914],
      time: '13:30',
      text: `Oude Haven √® l'antico porto di Rotterdam, oggi rinnovato con barche storiche e locali lungo le banchine. Qui svetta il Witte Huis (1898), considerato il primo "grattacielo" d'Europa: uno splendido edificio in stile Art Nouveau che resist√© ai bombardamenti del 1940. Il contrasto tra le imbarcazioni storiche e l'intorno moderno √® molto suggestivo.`
    },
    {
      id: 'zadkine',
      name: 'De Verwoeste Stad (Zadkine)',
      coord: [51.9133,4.4799],
      time: '13:45',
      text: `La scultura 'La citt√† distrutta' di Ossip Zadkine rappresenta una figura senza cuore: √® un monumento commemorativo potente dedicato alla devastazione causata dal bombardamento del 14 maggio 1940. Camminaci attorno e osserva come il vuoto centrale trasmetta perdita e dolore.`
    },
    {
      id: 'erasmus',
      name: 'Erasmusbrug (ponte)',
      coord: [51.9090,4.4827],
      time: '13:50',
      text: `L'Erasmusbrug, soprannominato 'Il Cigno', √® un ponte moderno con un unico pilone inclinato alto 139 m. Inaugurato nel 1996, √® diventato il simbolo contemporaneo di Rotterdam. Camminandoci sopra avrai ottime viste sul fiume e sulla skyline.`
    },
    {
      id: 'willems',
      name: 'Willemsplein 85 (imbarco crociera)',
      coord: [51.9097,4.4810],
      time: '14:00',
      text: `Willemsplein √® il punto di imbarco per le crociere portuali: da qui la navigazione di 75 minuti ti mostrer√† il porto, i terminal container e l'imponente infrastruttura marittima che ha fatto la fortuna di Rotterdam. √à una tappa imprescindibile per capire la scala del porto.`
    },
    {
      id: 'kop',
      name: 'Kop van Zuid / Hotel New York',
      coord: [51.9050,4.4860],
      time: '15:30',
      text: `Kop van Zuid √® la zona riqualificata sul lato sud: qui si trovano il complesso De Rotterdam e l'Hotel New York (ex sede Holland-America Line). L'hotel √® ricco di memoria storica: era da qui che partivano molte navi verso l'America.`
    }
  ];

  // ======= CREAZIONE MAPPA (Leaflet) =======
  const map = L.map('map').setView([51.9225,4.4799], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // marker icon (default)
  const icon = new L.Icon.Default();

  // add markers + sidebar entries
  const stopsContainer = document.getElementById('stops');
  const markers = {};
  stops.forEach((s, idx) => {
    const marker = L.marker(s.coord, {icon}).addTo(map).bindPopup(`<b>${s.name}</b><br><i>${s.time}</i><br>${s.text}`);
    markers[s.id] = marker;

    const div = document.createElement('div');
    div.className = 'stop';
    div.id = 'stop-'+s.id;

    const h = document.createElement('h3');
    h.textContent = (idx+1) + '. ' + s.name;
    div.appendChild(h);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<strong>Orario suggerito:</strong> ${s.time}`;
    div.appendChild(meta);

    const p = document.createElement('div');
    p.className = 'desc';
    p.textContent = s.text;
    div.appendChild(p);

    const controls = document.createElement('div');
    controls.className = 'controls';

    const play = document.createElement('button');
    play.className = 'btn small';
    play.textContent = '‚ñ∂Ô∏è Play audio';
    play.onclick = () => playStop(s.id);

    const pause = document.createElement('button');
    pause.className = 'btn alt small';
    pause.textContent = '‚è∏Ô∏è Pausa/Resume';
    pause.onclick = pauseResume;

    const stopBtn = document.createElement('button');
    stopBtn.className = 'btn green small';
    stopBtn.textContent = '‚èπÔ∏è Stop';
    stopBtn.onclick = stopAll;

    const nav = document.createElement('button');
    nav.className = 'btn small';
    nav.textContent = 'üìç GUIDAMI';
    nav.onclick = () => openNavigator(s.coord[0], s.coord[1]);

    controls.appendChild(play);
    controls.appendChild(pause);
    controls.appendChild(stopBtn);
    controls.appendChild(nav);

    div.appendChild(controls);
    stopsContainer.appendChild(div);

    // clicking the header zooms to marker
    h.style.cursor = 'pointer';
    h.onclick = () => { map.setView(s.coord, 17); marker.openPopup(); };
  });

  // draw polyline route
  const routeCoords = stops.map(s => s.coord);
  const route = L.polyline(routeCoords, {color:'#2a9df4', weight:4}).addTo(map);
  map.fitBounds(route.getBounds().pad(0.15));

  // ======= SPEECH SYNTHESIS LOGIC =======
  const synth = window.speechSynthesis;
  let voices = [];
  let currentUtterance = null;
  let playQueue = []; // sequence of stop ids when Play All
  let playingQueueIndex = 0;
  let paused = false;

  // populate voice select when available
  const voiceSelect = document.getElementById('voiceSelect');
  function populateVoices(){
    voices = synth.getVoices();
    voiceSelect.innerHTML = '';
    // prefer Italian voices first
    const itVoices = voices.filter(v => v.lang && v.lang.startsWith('it'));
    const otherVoices = voices.filter(v => !(v.lang && v.lang.startsWith('it')));
    const prefer = [...itVoices, ...otherVoices];
    prefer.forEach((v, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSelect.appendChild(opt);
    });
  }
  if (synth) {
    populateVoices();
    // Some browsers load voices asynchronously
    window.speechSynthesis.onvoiceschanged = populateVoices;
  }

  document.getElementById('rate').addEventListener('input', ()=>{ /* rate used at play time */ });

  function speakText(text, onend=null){
    if(!synth) { alert('Il tuo browser non supporta SpeechSynthesis.'); return; }
    stopAll(); // stop previous
    const utter = new SpeechSynthesisUtterance(text);
    const vIndex = voiceSelect.selectedIndex;
    if(voices && voices.length && vIndex >= 0 && voices[vIndex]) utter.voice = voices[vIndex];
    utter.lang = (utter.voice && utter.voice.lang) ? utter.voice.lang : 'it-IT';
    utter.rate = parseFloat(document.getElementById('rate').value) || 1;
    utter.pitch = 1;
    currentUtterance = utter;
    utter.onend = () => {
      currentUtterance = null;
      if (typeof onend === 'function') onend();
    };
    synth.speak(utter);
  }

  function playStop(id){
    const s = stops.find(x => x.id === id);
    if(!s) return;
    // scroll to stop on sidebar
    const el = document.getElementById('stop-'+id);
    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
    // open popup on map
    markers[id].openPopup();
    map.setView(s.coord, 16);
    // Compose spoken text (can be extended)
    const text = `${s.name}. ${s.text}`;
    speakText(text);
  }

  function pauseResume(){
    if(!synth) return;
    if(synth.speaking && !synth.paused){ synth.pause(); paused = true; }
    else if(synth.paused){ synth.resume(); paused = false; }
  }

  function stopAll(){
    if(!synth) return;
    synth.cancel();
    currentUtterance = null;
    playQueue = [];
    playingQueueIndex = 0;
  }

  // Play All (sequential)
  document.getElementById('playAll').addEventListener('click', ()=>{
    playQueue = stops.map(s => s.id);
    playingQueueIndex = 0;
    playNextInQueue();
  });

  function playNextInQueue(){
    if(playingQueueIndex >= playQueue.length) { playQueue = []; playingQueueIndex = 0; return; }
    const id = playQueue[playingQueueIndex];
    const s = stops.find(x => x.id === id);
    if(!s) return;
    const text = `${s.name}. ${s.text}`;
    speakText(text, ()=> {
      playingQueueIndex++;
      // small pause between stops
      setTimeout(playNextInQueue, 600);
    });
  }

  document.getElementById('pauseAll').addEventListener('click', pauseResume);
  document.getElementById('stopAll').addEventListener('click', stopAll);

  // locator button
  document.getElementById('locateMobile').addEventListener('click', ()=>{
    map.locate({setView:true, maxZoom:16});
  });
  map.on('locationfound', function(e){
    const r = e.accuracy / 2;
    L.marker(e.latlng).addTo(map).bindPopup("Sei qui").openPopup();
    L.circle(e.latlng, r, {color:'#2a9df4', fill:false}).addTo(map);
  });

  // external navigator opener
  function openNavigator(lat, lon){
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=walking`;
    if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream){
      // iOS: try maps:// then fallback
      window.location.href = `maps://?daddr=${lat},${lon}&dirflg=w`;
      setTimeout(()=>{ window.location.href = gmaps; }, 500);
    } else {
      window.open(gmaps,'_blank');
    }
  }

  // keyboard shortcuts: numbers 1..N jump to stops
  document.addEventListener('keydown', function(ev){
    const k = ev.key;
    if(k >= '1' && k <= String(stops.length)){
      const i = parseInt(k)-1;
      const s = stops[i];
      map.setView(s.coord, 17);
      markers[s.id].openPopup();
    }
  });

  // prefetch voices on first user interaction (some browsers require it)
  window.addEventListener('click', function loader(){ if(speechSynthesis) speechSynthesis.getVoices(); window.removeEventListener('click', loader); });

  // OPTIONAL: helper to show quick usage instructions in console
  console.log('Itinerario Rotterdam caricato. Premi Play All o usa i pulsanti di ogni tappa.');

  // ======= ISTRUZIONI PER REGISTRARE AUDIO (se vuoi MP3) =======
  // Se desideri ottenere file audio MP3, hai queste opzioni:
  // 1) Registra la riproduzione del browser usando un software di registrazione (Audacity, OBS) o app di registrazione dello smartphone.
  // 2) Usa servizi TTS online per generare MP3 (Google Cloud TTS, AWS Polly, ElevenLabs) inserendo i testi qui presenti.
  // 3) Su Chrome avanzato: √® possibile creare una pipeline WebAudio e registrare l'output, ma √® tecnica e non standard su tutti i browser.
  // Se vuoi, posso fornirti istruzioni dettagliate per l'opzione che preferisci.
  </script>
</body>
</html>